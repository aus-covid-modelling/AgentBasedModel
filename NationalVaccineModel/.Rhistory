install.packages("rjson")
library(tidyr)
library(readr)
library(dplyr)
library(rjson)
fromJSON(file = "D:/Work/dev/nationalvaccinemodel/NationalVaccineModel/dev-parameters.json")
params <- fromJSON(file = "D:/Work/dev/nationalvaccinemodel/NationalVaccineModel/dev-parameters.json")
params
args <- "dev-parameters"
parfile <- fromJSON(paste0("../", args[1], ".json"))
getwd()
parfile <- fromJSON(paste0("..\", args[1], ".json"))
folder <- paste0(parfile$output_director, parfile$folder_name)
num_sims <- length(list.files(folder))
file_name <- paste("./", folder,"/sim_number_",i,".csv",sep = "")
individuals <- read_csv(file_name)
# ggplot(dplyr::filter(individuals,`Time of symptom onset` < 600),aes(x = `Time of symptom onset`,fill = `Symptomatic`)) + geom_histogram(binwidth = 1) + scale_y_continuous("Incidence")
# ggplot(dplyr::filter(individuals,`Time of symptom onset` < 600),aes(x = `Time of infection`,y = `Secondary Infections`)) + geom_point() + geom_smooth()
infected_individuals <- individuals %>% dplyr::filter(!is.na(`Time of exposure`))
rm(individuals)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
# summary_df <- dplyr::filter(infected_individuals, (!is.na(`Date symptoms`))&(Symptomatic == "Symptomatic")) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine`, `Doses`) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i)
for(i in seq(2,num_sims,by = 1)){
file_name <- paste("./", folder,"/sim_number_",i,".csv",sep = "")
individuals <- read_csv(file_name)
#ggplot(individuals,aes(x = `Time of symptom onset`)) + geom_histogram(binwidth = 1)
infected_individuals <- individuals %>% dplyr::filter(!is.na(`Time of exposure`))
rm(individuals)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-bind_rows(completed_df,summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i) )
# completed_df <-bind_rows(completed_df,summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), `Doses at infection` = c(0,1,2)),Symptomatic,fill = list(incidence = 0))%>% mutate(Sim = i))
}
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`=="None"&(`Doses at infection`!=0)))
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`!="None"&(`Doses at infection`==0)))
completed_df <- dplyr::filter(completed_df, !is.na(`Date symptoms`))
wide_complete <- pivot_wider(completed_df,names_from = Sim,values_from = incidence)
write_csv(wide_complete,paste(folder,"_summary.csv",sep = ""))
write_csv(completed_df,paste(folder,"_summary_long.csv",sep = ""))
write_csv(wide_complete,paste("G:/My Drive/covid-vaccination-model-outputs/", folder,"_summary.csv",sep = ""))
write_csv(completed_df,paste("G:/My Drive/covid-vaccination-model-outputs/", folder,"_summary_long.csv",sep = ""))
parfile <- fromJSON(file=paste0("../", args[1], ".json"))
getwd()
parfile <- fromJSON(file=paste0(args[1], ".json"))
parfile
folder <- paste0(parfile$output_director, parfile$folder_name)
folder
num_sims <- length(list.files(folder))
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
i <- 1
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- read_csv(file_name)
library(data.table)
individuals <- fread(file_name)
num_sims <- length(list.files(folder))
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- fread(file_name)
# ggplot(dplyr::filter(individuals,`Time of symptom onset` < 600),aes(x = `Time of symptom onset`,fill = `Symptomatic`)) + geom_histogram(binwidth = 1) + scale_y_continuous("Incidence")
# ggplot(dplyr::filter(individuals,`Time of symptom onset` < 600),aes(x = `Time of infection`,y = `Secondary Infections`)) + geom_point() + geom_smooth()
infected_individuals <- individuals %>% dplyr::filter(!is.na(`Time of exposure`))
rm(individuals)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
# summary_df <- dplyr::filter(infected_individuals, (!is.na(`Date symptoms`))&(Symptomatic == "Symptomatic")) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine`, `Doses`) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i)
for(i in seq(2, num_sims, by=1)){
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- fread(file_name)
#ggplot(individuals,aes(x = `Time of symptom onset`)) + geom_histogram(binwidth = 1)
infected_individuals <- individuals %>% dplyr::filter(!is.na(`Time of exposure`))
rm(individuals)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-bind_rows(completed_df,summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i) )
# completed_df <-bind_rows(completed_df,summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), `Doses at infection` = c(0,1,2)),Symptomatic,fill = list(incidence = 0))%>% mutate(Sim = i))
}
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`=="None"&(`Doses at infection`!=0)))
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`!="None"&(`Doses at infection`==0)))
completed_df <- dplyr::filter(completed_df, !is.na(`Date symptoms`))
wide_complete <- pivot_wider(completed_df,names_from = Sim,values_from = incidence)
list.files(folder)
gsub(pattern = "sim_number_", "", list.files(folder))
gsub(pattern = "sim_number_|.csv", "", list.files(folder))
sim_numbers <- gsub(pattern = "sim_number_|.csv", "", list.files(folder)) %>% as.numeric()
completed_df <- lapply(sim_numbers, function(i) {
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- fread(file_name)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i)
}) %>% rbindlist()
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
i <- 1
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- fread(file_name)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
max_t  = 600
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i)
completed_df <- lapply(sim_numbers, function(i) {
file_name <- paste(folder,"/sim_number_",i,".csv",sep = "")
individuals <- fread(file_name)
infected_individuals <- mutate(infected_individuals, `Age bracket` = cut(Age, breaks = c(seq(0,80,by = 5),Inf),include.lowest = TRUE, right= FALSE))
infected_individuals <- mutate(infected_individuals, `Date symptoms` = cut(`Time of symptom onset`, breaks = seq(0,max_t,by = 1),include.lowest = FALSE, right= TRUE,labels = FALSE)) #Currently ignores symptoms at 0.
summary_df <- dplyr::filter(infected_individuals) %>% group_by(`Date symptoms`, `Age bracket`,`Vaccine at infection`, `Doses at infection`,Symptomatic) %>% summarise(incidence = n()) #Filter it to be only symptomatic infections.
completed_df <-summary_df %>% ungroup() %>% complete(expand(infected_individuals,`Date symptoms` = seq(0,max_t,by=1), `Age bracket`,`Vaccine at infection` = c("None","Pfizer","Moderna","Astrazeneca"), Symptomatic,`Doses at infection` = c(0,1,2)),fill = list(incidence = 0))%>% mutate(Sim = i)
}) %>% rbindlist()
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`=="None"&(`Doses at infection`!=0)))
completed_df <- dplyr::filter(completed_df, !(`Vaccine at infection`!="None"&(`Doses at infection`==0)))
completed_df <- dplyr::filter(completed_df, !is.na(`Date symptoms`))
wide_complete <- pivot_wider(completed_df,names_from = Sim,values_from = incidence)
folder
args <- c("parameters/dev/dev-parameters", 10)
args
parfile <- fromJSON(file=paste0(args[1], ".json"))
max_iter <- as.numeric(args[2])
parfile
parfile$start_sims <- i
parfile
rjson::toJSON(parfile)
?write
args[1] <- "dev/dev-parameters.json"
parfile <- fromJSON(file=args[1])
args[1] <- "parameters/dev/dev-parameters.json"
parfile <- fromJSON(file=args[1])
parfile
fname
fname <- paste0(args[1])
fname
gsub(".json", "", fname)
max_iter <- 5
for (i in 1:max_iter) {
parfile$start_sims <- i
write(rjson::toJSON(parfile), file=paste0(gsub(".json", "", fname), "_", i, ".json"))
}
getwd()
install.packages("jsonlite")
library(jsonlite)
rjson::toJSON(parfile)
prettify(rjson::toJSON(parfile))
for (i in 1:max_iter) {
parfile$start_sims <- i
js <- rjson::toJSON(parfile)
write(jsonlite::prettify(js), file=paste0(gsub(".json", "", fname), "_", i, ".json"))
}
args
